// all scraping stuff
const logger = require('logger.js')("Scraping module");
const rp = require('request-promise').defaults({jar: true});
const cheerio = require('cheerio');
const dt = require('data-tables');
const config = require('../config.json');
const LINK = 'https://www.novaragnarok.com';

async function getPage(url, qs = {}) {
  
  const returnqs = Object.keys(qs).map(key => `${key}=${qs[key]}`).join('&');

  const options = {
    method: 'POST',
    uri:    url,
    qs: {
      module: 'account',
      action: 'login',
      'return_url': `/?${returnqs}`, 
    },
    form: {
      username: config.novaUsername,
      password: config.novaPassword,
      server: 'NovaRO',
    },
    followAllRedirects: true,
    transform: (body) => {
      return cheerio.load(body);
    },
  };

  return rp(options)
    .then($ => {
      return $;
    })
    .catch(err => {
      logger.error(`An error has occurred on request. ${err}`);
    });
}

exports.getPage = getPage;
