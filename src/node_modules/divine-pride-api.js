const logger = require('logger.js')("Divine Pride API Module");
const rp = require('request-promise');
const baseLink = "https://divine-pride.net";
const links = {
  api: `${baseLink}/api/database`,
  db: `${baseLink}/database`,
  sprite: `${baseLink}/images/@type/png/@id.png`,
  icon: `${baseLink}/Content/img/@icon.png`,
};

const types = {
  mob: {
    apiName: "Monster",
    typeName: "monster",
    iconName: "battle",
    spriteName: "mobs",
  },
  item: {
    apiName: "Item",
    typeName: "item",
    iconName: "equipment",
    spriteName: "item",
  },
};

const ELEMENT_LIST = [
  {
    "name" : "Neutral",
    "colour" : 16777215,
  },
  {
    "name" : "Water",
    "colour" : 8103905,
  },
  {
    "name" : "Earth",
    "colour" : 14331781,
  },
  {
    "name" : "Fire",
    "colour" : 16741749,
  },
  {
    "name" : "Wind",
    "colour" : 13303480,
  },
  {
    "name" : "Poison",
    "colour" : 4980344,
  },
  {
    "name" : "Holy",
    "colour" : 16777130,
  },
  {
    "name" : "Dark",
    "colour" : 10837995,
  },
  {
    "name" : "Ghost",
    "colour" : 7829367,
  },
  {
    "name" : "Undead",
    "colour" : 0,
  }
];

const ELEMENT_LEVEL_LIST = [
  "",
  "1",
  "2",
  "2",
  "4"
];

const SCALE_LIST = [
  "Small",
  "Medium",
  "Large",
];

const RACE_LIST = [
  "Formless",
  "Undead",
  "Brute",
  "Plant",
  "Insect",
  "Fish",
  "Demon",
  "Human",
  "Angel",
  "Dragon",
];

async function getApiJSON(message, args, apikey, type) {
  if (args.length === 0) {
    message.channel.send("Need to specify an id.");
    return;
  }

  args = args.length > 1 ? args[0] : args;

  if (isNaN(args)) {
    message.channel.send("Id needs to be an integer.");
    return;
  }
 
  logger.info(args);
  return getJSONReply(getAPILink(type, args), apikey);
};

async function getJSONReply(url, key) {
  const options = {
    method: 'GET',
    json:   true,
    url:    url,
    qs: {
      apiKey: key,
    }
  };  
  
  return rp(options)
    .then(body => {
      return body;
    })
    .catch(error => {
      logger.error(`An error occurred on request. Please try again. ${error}`);
    });
};

function getElement(value) {
  return {
    type: ELEMENT_LIST[value % 10],
    level: ELEMENT_LEVEL_LIST[Math.floor(value / 20)],
  };
};
function getScale(value) {
  return SCALE_LIST[value];
};

function getRace(value) {
  return RACE_LIST[value];
};

function getSpriteLink(type, id) {
  return links.sprite
    .replace("@type", type)
    .replace("@id", id);
};

function getIconLink(iconName) {
  return links.icon
    .replace("@icon", iconName);
};

function getDBLink(type, id) {
  return `${links.db}/${type}/${id}`;
};

function getAPILink(type, id) {
  const link = `${links.api}/${type}/${id}`;
  return link;
};


module.exports = {
  getApiJSON,
  getJSONReply,
  getElement,
  getScale,
  getRace,
  getSpriteLink,
  getIconLink,
  getDBLink,
  getAPILink,
  types,
};
